{% extends "layout.html" %}
{% block title %}{{ room.name }}{% endblock %}

{% block content %}
<div class="d-flex flex-column" style="height: 75vh;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0">üí¨ Room: {{ room.name }}</h4>
        <a href="{{ url_for('rooms') }}" class="btn btn-sm btn-outline-secondary">‚Üê Back to Rooms</a>
    </div>

    <!-- Chat Messages -->
    <div id="chat-box" class="bg-light border rounded p-3 mb-3 flex-grow-1 overflow-auto" style="height: 100%;">
        {% for msg in messages %}
        <div class="mb-2">
            <strong class="text-primary">{{ msg.user.username }}</strong>
            <small class="text-muted">({{ msg.timestamp.strftime('%H:%M') }})</small>:
            <span>{{ msg.content }}</span>
        </div>
        {% endfor %}
    </div>

    <!-- Message Input -->
    <form id="chat-form" class="d-flex">
        <input type="text" id="message-input" class="form-control me-2" placeholder="Type a message..." autocomplete="off">
        <button class="btn btn-primary" type="submit">Send</button>
    </form>
</div>

<!-- JS -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();

    socket.emit('join', {
        room_id: {{ room.id }},
        username: "{{ current_user.username }}"
    });

    // Incoming messages
    socket.on('message', function(data) {
        const chatBox = document.getElementById('chat-box');
        const msgHtml = `<div class="mb-2">
            <strong class="text-primary">${data.username}</strong>
            <small class="text-muted">(${data.timestamp})</small>:
            <span>${data.content}</span>
        </div>`;
        chatBox.innerHTML += msgHtml;
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Send message
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (message) {
            socket.emit('send_message', {
                room_id: {{ room.id }},
                username: "{{ current_user.username }}",
                content: message
            });
            input.value = '';
        }
    });
</script>
{% endblock %}
