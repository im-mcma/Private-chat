{% extends "layout.html" %}
{% block title %}Chat - {{ room.name }}{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">üí¨ Room: {{ room.name }}</h4>
    <a href="{{ url_for('rooms') }}" class="btn btn-outline-secondary btn-sm">‚Üê Back to Rooms</a>
  </div>

  <div class="card shadow-sm chat-box" style="height: 60vh; overflow-y: auto;" id="chat-box">
    <ul class="list-group list-group-flush" id="messages">
      {% for msg in messages %}
      <li class="list-group-item {% if msg.username == current_user.username %}bg-light text-end{% endif %}">
        <div class="fw-semibold">{{ msg.username }}</div>
        <div>{{ msg.content }}</div>
        <small class="text-muted">{{ msg.timestamp.strftime('%H:%M') }}</small>
      </li>
      {% endfor %}
    </ul>
  </div>

  <form id="chat-form" class="mt-3 d-flex">
    <input type="text" id="message" class="form-control me-2" placeholder="Type your message..." autocomplete="off">
    <button class="btn btn-primary">Send</button>
  </form>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io();
  const room = "{{ room.name }}";
  const username = "{{ current_user.username }}";

  socket.emit("join_room", { room });

  document.getElementById("chat-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const msgInput = document.getElementById("message");
    const message = msgInput.value.trim();
    if (message !== "") {
      socket.emit("send_message", { message, room, username });
      msgInput.value = "";
    }
  });

  socket.on("receive_message", data => {
    const messagesList = document.getElementById("messages");
    const li = document.createElement("li");
    li.className = "list-group-item" + (data.username === username ? " bg-light text-end" : "");
    li.innerHTML = `
      <div class="fw-semibold">${data.username}</div>
      <div>${data.message}</div>
      <small class="text-muted">${data.time}</small>
    `;
    messagesList.appendChild(li);
    document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
  });
</script>
{% endblock %}
