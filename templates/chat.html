{% extends "layout.html" %}
{% block title %}چت روم {{ room.name }}{% endblock %}

{% block head %}
<style>
  #messages {
    height: 400px;
    overflow-y: scroll;
    background: #fff;
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
    font-family: Vazir, sans-serif;
    direction: rtl;
  }
  #messages div {
    margin-bottom: 0.5rem;
  }
  #message-input {
    resize: none;
  }
</style>
{% endblock %}

{% block content %}
<h2 class="mb-3">چت روم: {{ room.name }}</h2>
<div id="messages">
  {% for message in messages %}
    <div><strong>{{ message.user.username }}:</strong> {{ message.content }}</div>
  {% else %}
    <div>هیچ پیامی وجود ندارد.</div>
  {% endfor %}
</div>
<form id="chat-form">
  <div class="input-group">
    <textarea id="message-input" class="form-control" rows="2" placeholder="پیام خود را وارد کنید..." required></textarea>
    <button type="submit" class="btn btn-primary">ارسال</button>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
<script>
  const socket = io();
  const roomName = "{{ room.name }}";
  const username = "{{ username }}";

  const messagesDiv = document.getElementById('messages');
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');

  function scrollToBottom() {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  socket.on('connect', () => {
    socket.emit('join', { room: roomName });
  });

  socket.on('message', (msg) => {
    const div = document.createElement('div');
    div.textContent = msg;
    messagesDiv.appendChild(div);
    scrollToBottom();
  });

  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const msg = messageInput.value.trim();
    if (!msg) return;
    socket.emit('message', msg);
    messageInput.value = '';
  });

  window.addEventListener('beforeunload', () => {
    socket.emit('leave');
  });
</script>
{% endblock %}
